name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]

env:
  GO_VERSION: '1.21'
  LLAMA_CPP_BUILD: 'b6076'

jobs:
  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        go-version: ['1.21', '1.22','1.24']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

    - name: Set up Go
      uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5
      with:
        go-version: ${{ matrix.go-version }}

    - name: Cache Go modules
      uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ matrix.go-version }}-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-${{ matrix.go-version }}-

    - name: Install dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential

    - name: Install dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install cmake

    - name: Install dependencies (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        choco install cmake

    - name: Download dependencies
      run: go mod download

    - name: Verify platform compatibility
      run: |
        echo "Testing platform compatibility..."
        go build -v ./...
        echo "Build successful for ${{ runner.os }}"

    - name: Run tests
      run: go test -v ./...

    - name: Run platform-specific tests
      run: go test -v -run TestPlatformSpecific ./...

    # - name: Cross-compile test (Windows)
    #   if: matrix.os != 'windows-latest'
    #   run: |
    #     echo "Testing Windows cross-compilation..."
    #     GOOS=windows GOARCH=amd64 go build -v ./...

    # - name: Cross-compile test (Linux)
    #   if: matrix.os != 'ubuntu-latest'
    #   run: |
    #     echo "Testing Linux cross-compilation..."
    #     GOOS=linux GOARCH=amd64 go build -v ./...

    # - name: Cross-compile test (macOS)
    #   if: matrix.os != 'macos-latest'
    #   run: |
    #     echo "Testing macOS cross-compilation..."
    #     GOOS=darwin GOARCH=amd64 go build -v ./...

    - name: Run tests with race detection
      if: matrix.os != 'windows-latest' # Race detector not fully supported on Windows
      run: go test -race -v ./...

    - name: Run benchmarks
      run: go test -bench=. -benchmem ./...

  # cross-platform:
  #   name: Cross-Platform Compatibility
  #   runs-on: ubuntu-latest
    
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

  #   - name: Set up Go
  #     uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5
  #     with:
  #       go-version: ${{ env.GO_VERSION }}

  #   - name: Download dependencies
  #     run: go mod download

  #   - name: Test all platform builds
  #     run: |
  #       echo "Testing cross-compilation for all supported platforms..."
        
  #       # Test Windows (both architectures)
  #       echo "Building for Windows amd64..."
  #       GOOS=windows GOARCH=amd64 go build -v ./...
  #       echo "Building for Windows arm64..."
  #       GOOS=windows GOARCH=arm64 go build -v ./...
        
  #       # Test Linux (both architectures)
  #       echo "Building for Linux amd64..."
  #       GOOS=linux GOARCH=amd64 go build -v ./...
  #       echo "Building for Linux arm64..."
  #       GOOS=linux GOARCH=arm64 go build -v ./...
        
  #       # Test macOS (both architectures)
  #       echo "Building for macOS amd64..."
  #       GOOS=darwin GOARCH=amd64 go build -v ./...
  #       echo "Building for macOS arm64..."
  #       GOOS=darwin GOARCH=arm64 go build -v ./...
        
  #       echo "All cross-compilation tests passed!"

  #   - name: Test platform-specific code coverage
  #     run: |
  #       echo "Testing platform-specific code paths..."
  #       go test -v -coverprofile=coverage.out ./...
  #       go tool cover -func=coverage.out

  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

    - name: Set up Go
      uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: golangci-lint
      uses: golangci/golangci-lint-action@4afd733a84b1f43292c63897423277bb7f4313a9 # v8
      with:
        version: latest

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

    - name: Set up Go
      uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Run Gosec Security Scanner
      uses: securego/gosec@master
      with:
        # Exclude acceptable issues and set severity to medium:
        # G103: Use of unsafe calls (necessary for C interop)
        # G104: Errors unhandled (acceptable for non-critical operations)
        # G115: Integer overflow with validation (all conversions are validated)
        # G304: File inclusion via variable (expected in CLI tools)
        # This reduces noise while focusing on actionable security issues
        args: '-exclude=G103,G104,G115,G304 -severity=medium ./...'

  build-libs:
    name: Build Libraries
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux builds with auto-detection for CUDA/HIP/CPU-only
          - os: ubuntu-latest
            platform: linux
            arch: amd64
            gpu_type: auto-detect
            description: "Auto-detect CUDA/HIP or CPU-only"
          - os: ubuntu-latest
            platform: linux
            arch: arm64
            gpu_type: auto-detect
            description: "Auto-detect CUDA/HIP or CPU-only"
          # macOS builds with Metal support
          - os: macos-latest
            platform: darwin
            arch: amd64
            gpu_type: metal
            description: "Metal GPU acceleration"
          - os: macos-latest
            platform: darwin
            arch: arm64
            gpu_type: metal
            description: "Metal GPU acceleration"
          # Windows builds with CUDA support
          - os: windows-latest
            platform: windows
            arch: amd64
            gpu_type: cuda
            description: "CUDA GPU acceleration"
    
    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

    - name: Cache llama.cpp
      uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4
      with:
        path: build/llama.cpp
        key: llama-cpp-${{ env.LLAMA_CPP_BUILD }}-${{ matrix.platform }}-${{ matrix.arch }}

    - name: Install dependencies (Ubuntu)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential patchelf
        if [[ "${{ matrix.arch }}" == "arm64" ]]; then
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
        fi
        # Note: CUDA and ROCm SDKs are auto-detected by the Makefile
        # No need to install them in CI as they're optional

    - name: Install dependencies (macOS)
      if: matrix.platform == 'darwin'
      run: |
        brew install cmake

    - name: Install dependencies (Windows)
      if: matrix.platform == 'windows'
      run: |
        choco install cmake

    - name: Set up CUDA (Windows only)
      if: matrix.platform == 'windows' && matrix.gpu_type == 'cuda'
      uses: Jimver/cuda-toolkit@v0.2.26 # v0.2.26
      with:
        cuda: '12.9.1'
        method: 'network'
        use-github-cache: false
        use-local-cache: true
        log-file-suffix: 'cuda-install.log'
        sub-packages: '["nvcc", "cudart", "thrust", "cufft", "curand", "cusolver", "cusparse", "cublas"]'

    - name: Clone and build llama.cpp using Makefile
      env:
        LLAMA_CPP_BUILD: ${{ env.LLAMA_CPP_BUILD }}
      run: |
        echo "Building for ${{ matrix.platform }}-${{ matrix.arch }} with ${{ matrix.description }}"
        make clone-llamacpp
        make build-llamacpp-${{ matrix.platform }}-${{ matrix.arch }}

    - name: Upload library artifacts
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
      with:
        name: libs-${{ matrix.platform }}-${{ matrix.arch }}
        path: libs/${{ matrix.platform }}_${{ matrix.arch }}/

  # test-hip:
  #   name: Test HIP Support
  #   runs-on: ubuntu-latest
  #   needs: build-libs
  #   if: github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'test-hip')
    
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
    
  #   - name: Install ROCm (HIP) SDK
  #     run: |
  #       wget -q -O - https://repo.radeon.com/rocm/rocm.gpg.key | sudo apt-key add -
  #       echo 'deb [arch=amd64] https://repo.radeon.com/rocm/apt/debian/ ubuntu main' | sudo tee /etc/apt/sources.list.d/rocm.list
  #       sudo apt-get update
  #       sudo apt-get install -y rocm-dev hip-dev
  #       echo "/opt/rocm/bin" >> $GITHUB_PATH
  #       echo "ROCM_PATH=/opt/rocm" >> $GITHUB_ENV
    
  #   - name: Test HIP detection
  #     run: |
  #       echo "Testing HIP detection and build configuration..."
  #       make clone-llamacpp
  #       # This should detect HIP and configure build accordingly
  #       cd build/llama.cpp/build-linux-amd64
  #       if cmake --version >/dev/null 2>&1; then
  #         cmake .. -DGGML_HIP=ON 2>&1 | tee hip-config.log
  #         if grep -q "HIP found" hip-config.log; then
  #           echo "✅ HIP detected successfully"
  #         else
  #           echo "❌ HIP detection failed"
  #           exit 1
  #         fi
  #       fi

  # build:
  #   name: Build Go Bindings
  #   runs-on: ubuntu-latest
  #   needs: [test, lint, security]
  #   strategy:
  #     matrix:
  #       goos: [linux, darwin, windows]
  #       goarch: [amd64, arm64]
  #       exclude:
  #         - goos: windows
  #           goarch: arm64  # Windows ARM64 Go support is limited

  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

  #   - name: Set up Go
  #     uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5
  #     with:
  #       go-version: ${{ env.GO_VERSION }}

  #   - name: Cache Go modules
  #     uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4
  #     with:
  #       path: |
  #         ~/.cache/go-build
  #         ~/go/pkg/mod
  #       key: ${{ runner.os }}-go-${{ env.GO_VERSION }}-${{ hashFiles('**/go.sum') }}

  #   - name: Download dependencies
  #     run: go mod download

  #   - name: Build
  #     env:
  #       GOOS: ${{ matrix.goos }}
  #       GOARCH: ${{ matrix.goarch }}
  #       CGO_ENABLED: 0
  #     run: make build

  #   - name: Upload build artifacts
  #     uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
  #     with:
  #       name: build-${{ matrix.goos }}-${{ matrix.goarch }}
  #       path: build/${{ matrix.goos }}_${{ matrix.goarch }}/

  release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: [build-libs, examples, documentation]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

    - name: Download all artifacts
      uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4

    - name: Create release packages
      run: |
        mkdir -p dist
        
        # Extract version from tag
        VERSION=${GITHUB_REF#refs/tags/v}
        
        # Package each platform
        for platform in linux darwin windows; do
          for arch in amd64 arm64; do
            # Skip unsupported combinations
            if [[ "$platform" == "windows" && "$arch" == "arm64" ]]; then
              continue
            fi
            
            echo "Packaging $platform-$arch"
            pkg_name="gollama.cpp-v$VERSION-llamacpp.${{ env.LLAMA_CPP_BUILD }}-$platform-$arch"
            mkdir -p "dist/$pkg_name"
            
            # Copy Go binaries if they exist
            if [ -d "build-$platform-$arch" ]; then
              cp -r build-$platform-$arch/* "dist/$pkg_name/"
            fi
            
            # Copy libraries if they exist
            if [ -d "libs-$platform-$arch" ]; then
              cp -r libs-$platform-$arch/* "dist/$pkg_name/"
            fi
            
            # Copy documentation
            cp README.md LICENSE CHANGELOG.md "dist/$pkg_name/"
            
            # Create archive
            cd dist
            if [[ "$platform" == "windows" ]]; then
              zip -r "$pkg_name.zip" "$pkg_name"
            else
              tar -czf "$pkg_name.tar.gz" "$pkg_name"
            fi
            rm -rf "$pkg_name"
            cd ..
          done
        done

    - name: Extract release notes
      id: extract_notes
      run: |
        # Extract release notes from CHANGELOG.md
        VERSION=${GITHUB_REF#refs/tags/v}
        sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d' > release_notes.md

    - name: Create GitHub Release
      uses: actions/create-release@0cb9c9b65d5d1901c1f53e5e66eaf4afd303e70e # v1
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body_path: release_notes.md
        draft: false
        prerelease: false

    - name: Upload Release Assets
      run: |
        for file in dist/*; do
          if [ -f "$file" ]; then
            echo "Uploading $file"
            curl \
              -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/octet-stream" \
              --data-binary @"$file" \
              "${{ steps.create_release.outputs.upload_url }}?name=$(basename $file)"
          fi
        done

  examples:
    name: Build Examples
    runs-on: ${{ matrix.os }}
    needs: [build-libs]
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

    - name: Set up Go
      uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Download library artifacts
      uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
      with:
        pattern: libs-*
        merge-multiple: true
        path: libs/

    - name: Build examples
      run: make build-examples

  documentation:
    name: Generate Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

    - name: Set up Go
      uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Generate Go documentation
      run: |
        go doc -all . > docs/API.md || true

    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e # v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
